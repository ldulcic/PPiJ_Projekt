<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="jquery-1.11.3.min.js"></script>


</head>

<body>
<h2>London</h2>

<p>London is the capital city of England. It is the most populous city in the United Kingdom, with a metropolitan area of over 13 million inhabitants.</p>

<div id="title">Dodavanje čvorova</div>

<DIV id = "canvas" style="background-color:black; height:400px; width:900px" >

</DIV>
<button type="button" onclick="changeMode()">Click Me!</button>

</body>

<script src="jsnetworkx.js"></script>
<script type="text/javascript">
// -------------------------------------------
//                 OBJECTS
// -------------------------------------------

// ---------------- NODE ----------------
function Node(x, y) {
  this.x = x;
  this.y = y;
  this.links = [];
}

Node.prototype = {

  value: null,

  constructor: Node,

  addLink: function(link) {
    this.links.push(link);
  },

  removeLink: function(link) {
    var i = this.links.indexOf(link);
    if (i > -1) {
      this.links.splice(i, 1);
    }
  },

  expand: function() {
    var nodes = [];
    var node;
    for (var i = this.links.length - 1; i >= 0; i--) {
      node = this.links[i].node;
      if(node.value != null) continue;
      node.links = node.links;
      node.value = parseInt(this.value) + parseInt(this.links[i].value);
      nodes.push(node);
    }
    return nodes;
  }

};

// ---------------- LINK ----------------
function Link(node, value) {
  this.node = node;
  this.value = value;
}

Link.prototype = {
  constructor: Link
};

// ---------------- DIJKSTRA ----------------
function Dijkstra (nodes) {
  this.nodes = nodes;
  this.openNodes = [];
  this.visited = [];
  this.path = [];
}

Dijkstra.prototype = {
  constructor: Dijkstra,

  getPath: function (start, end) {
    start.value = 0;
    this.openNodes.push(start);
    var current;

    while(this.openNodes.length > 0) {
      current = this.getNext();
      if(current == []) return [];

      if(current == end) {
        this.path.push(current);
        return this.path;
      }

      this.expand(current.expand());
      this.visited.push(current);
      this.path.push(current);
      /*console.log("path");
      console.log(current);*/
    }
    return [];
  },

  expand: function (nodes) {
    for (var i = nodes.length - 1; i >= 0; i--) {
      if(this.visited.indexOf(nodes[i]) == -1) {
        this.addToOpen(nodes[i]);
      }
    }
  },

  getNext: function () {
    while(this.openNodes.length != 0) {
      for (var i = this.openNodes.length - 1; i >= 0; i--) {
        if(this.visited.indexOf(this.openNodes[i]) == -1) {
          return this.openNodes.splice(i, 1)[0];
        }
        this.openNodes.pop();
      }
    }
  },

  addToOpen: function (node) {
  	if(this.openNodes.length == 0) {
  		this.openNodes.push(node);
  		return;
  	}

    for (var i = this.openNodes.length - 1; i >= 0; i--) {
      if(this.openNodes[i].value > node.value) {
        this.openNodes.splice(i, node);
      }
    }
  }
};

// ---------------- MODES ----------------
var GraphMode = Object.freeze({
	ADDING_NODES: 1,
	ADDING_LINKS: 2,
	PICKING_START_END: 3,
	READY: 4
});

// -------------------------------------------
//                   MAIN
// -------------------------------------------

var WIDTH = 900, HEIGHT = 400;
var canv = d3.select("#canvas").append("svg");
canv.attr("onclick", "addNode(event)")
	.attr("width", WIDTH)
	.attr("height", HEIGHT);
canv.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", "pink");
var c = document.getElementById("canvas");

var mode = GraphMode.ADDING_NODES;
var firstNode = null;
var startNode = null;
var endNode = null;
var nodes = [];

function nodeHandler(node) {
	if (mode == GraphMode.ADDING_LINKS) {
		if (firstNode == null) {
			firstNode = node;
		} else {
			var x1 = firstNode.getAttribute("cx");
			var y1 = firstNode.getAttribute("cy");
			var x2 = node.getAttribute("cx");
			var y2 = node.getAttribute("cy");
			canv.append("svg:line")
				.attr("x1", x1)
				.attr("y1", y1)
				.attr("x2", x2)
				.attr("y2", y2)
				.text("hehehe")
				.style("stroke", "rgb(6,120,155)");
			
			var weight = addWeight(x1, y1, x2, y2);
			var n1 = getNode(x1, y1);
			var n2 = getNode(x2, y2);

			n1.addLink(new Link(n2, weight));
			n2.addLink(new Link(n1, weight));

			firstNode = null;
		}
	} else if (mode == GraphMode.PICKING_START_END) {
		if (startNode == null) {
			node.setAttribute("fill", "green");
			var x = node.getAttribute("cx");
			var y = node.getAttribute("cy");
			startNode = getNode(x, y);
		} else {
			node.setAttribute("fill", "red");
			var x = node.getAttribute("cx");
			var y = node.getAttribute("cy");
			endNode = getNode(x, y);
		}
	} else if (mode == GraphMode.READY) {
		// todo
	}
}

function getNode(x, y) {
	for (var i = nodes.length - 1; i >= 0; i--) {
		if (nodes[i].x == x && nodes[i].y == y) {
			return nodes[i];
		}
	}
	return null;
}

function addWeight(x1, y1, x2, y2) {
	var message = "Unesite težinu.";
	var xmin = parseInt(x1) < parseInt(x2) ? x1 : x2;
	var ymin = parseInt(y1) < parseInt(y2) ? y1 : y2;
	var xt = parseInt(xmin) + parseInt(Math.abs((x1-x2)/2));
	var yt = parseInt(ymin) + parseInt(Math.abs((y1-y2)/2));

	while (true) {
		var weight = prompt(message);

		if (isNaN(weight)) {
			message = "Potrebno je unijeti broj!"
			continue;
		}
		canv.append("svg:text")
			.attr("x",xt)
			.attr("y",yt)
			.attr("fill","black")
			.text(weight);
		return weight;
	}
}

function changeMode() {
	if (mode == GraphMode.ADDING_NODES) {
		mode = GraphMode.ADDING_LINKS;
	} else if (mode == GraphMode.ADDING_LINKS) {
		mode = GraphMode.PICKING_START_END;
	} else if (mode == GraphMode.PICKING_START_END) {
		mode = GraphMode.READY;
		startAlgorithm();
	}
}

function startAlgorithm() {
	var d = new Dijkstra(nodes);
	console.log(d.getPath(startNode, endNode));
}

function addNode(event) {
	if (mode == GraphMode.ADDING_NODES) {
		var relX = event.clientX - c.getBoundingClientRect().left;
		var relY = event.clientY - c.getBoundingClientRect().top;
		canv.append("svg:circle")
			.attr("cx", relX)
			.attr("cy", relY)
			.attr("onclick", "nodeHandler(this)")
			.attr("r", "10px")
			.attr("fill", "blue");
		nodes.push(new Node(relX, relY)); 
	}
}

</script>

</html>